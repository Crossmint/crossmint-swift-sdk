name: Auto Release

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  auto-release:
    name: Create Release
    # Only run if PR was merged and has the "release" label
    if: github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'release')
    runs-on: macos-15
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
      with:
        ref: main

    - name: Extract version from PR title
      id: extract_version
      run: |
        PR_TITLE="${{ github.event.pull_request.title }}"
        # Extract version from title like "Release 0.0.8" or "Release 0.0.8-beta"
        VERSION=$(echo "$PR_TITLE" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?')

        if [ -z "$VERSION" ]; then
          echo "Error: Could not extract version from PR title: $PR_TITLE"
          exit 1
        fi

        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "✅ Extracted version: $VERSION"

    - name: Verify version in SDKVersion.swift matches
      run: |
        VERSION="${{ steps.extract_version.outputs.version }}"
        if ! grep -q "public static let version = \"$VERSION\"" Sources/Utils/SDKVersion.swift; then
          echo "Error: Version in SDKVersion.swift does not match PR version"
          echo "Expected: $VERSION"
          echo "Current content:"
          cat Sources/Utils/SDKVersion.swift
          exit 1
        fi
        echo "✅ Version verified in SDKVersion.swift"

    - name: Create and push tag
      run: |
        VERSION="${{ steps.extract_version.outputs.version }}"
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        git tag "$VERSION"
        git push origin "$VERSION"
        echo "✅ Created and pushed tag: $VERSION"

    - name: Create GitHub Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        VERSION="${{ steps.extract_version.outputs.version }}"
        gh release create "$VERSION" \
          --title "Release $VERSION" \
          --generate-notes
        echo "✅ Created GitHub release: $VERSION"
